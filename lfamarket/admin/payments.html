<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>Admin Dashboard</title>

    <!-- Custom fonts for this template-->
    <link
      href="../assets/vendor/fontawesome-free/css/all.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet"
    />

    <!-- Custom styles for this template-->
    <link href="../assets/css/sb-admin-2.min.css" rel="stylesheet" />
    <link
      href="../assets/vendor/datatables/dataTables.bootstrap4.min.css"
      rel="stylesheet"
    />

    <script src="../assets/js/admin-auth.js"></script>

    <style>
      td {
        text-align: center;
        text-transform: capitalize;
      }
      th {
        text-align: center;
      }
    </style>
  </head>

  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <ul
        class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion"
        id="accordionSidebar"
      >
        <!-- Sidebar - Brand -->
        <a
          class="sidebar-brand d-flex align-items-center justify-content-center"
          href="index.html"
        >
          <div class="sidebar-brand-icon rotate-n-15">
            <i class="fas fa-laugh-wink"></i>
          </div>
          <div class="sidebar-brand-text mx-3" id="username">Username</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0" />

        <!-- Nav Item - Dashboard -->
        <li class="nav-item active">
          <a class="nav-link" href="home.html">
            <i class="fas fa-fw fa-tachometer-alt"></i>
            <span>Dashboard</span></a
          >
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="users.html">
            <i class="fa fa-user-circle" aria-hidden="true"></i>
            <span>Users</span></a
          >
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="investors.html">
            <i class="fa fa-user-circle" aria-hidden="true"></i>
            <span>Investors</span></a
          >
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="payments.html">
            <i class="fa fa-user-circle" aria-hidden="true"></i>
            <span>Payments</span></a
          >
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="referrals.html">
            <i class="fa fa-user-circle" aria-hidden="true"></i>
            <span>Referrals</span></a
          >
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider" />

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
          <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>
      </ul>
      <!-- End of Sidebar -->

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
          <!-- Topbar -->
          <nav
            class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow"
          >
            <!-- Sidebar Toggle (Topbar) -->
            <button
              id="sidebarToggleTop"
              class="btn btn-link d-md-none rounded-circle mr-3"
            >
              <i class="fa fa-bars"></i>
            </button>

            <!-- Topbar Search -->
            <form
              class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search"
            >
              <div class="input-group">
                <input
                  type="text"
                  class="form-control bg-light border-0 small"
                  placeholder="Search for..."
                  aria-label="Search"
                  aria-describedby="basic-addon2"
                />
                <div class="input-group-append">
                  <button class="btn btn-primary" type="button">
                    <i class="fas fa-search fa-sm"></i>
                  </button>
                </div>
              </div>
            </form>

            <!-- Topbar Navbar -->
            <ul class="navbar-nav ml-auto">
              <!-- Nav Item - Search Dropdown (Visible Only XS) -->
              <li class="nav-item dropdown no-arrow d-sm-none">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="searchDropdown"
                  role="button"
                  data-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <i class="fas fa-search fa-fw"></i>
                </a>
                <!-- Dropdown - Messages -->
                <div
                  class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in"
                  aria-labelledby="searchDropdown"
                >
                  <form class="form-inline mr-auto w-100 navbar-search">
                    <div class="input-group">
                      <input
                        type="text"
                        class="form-control bg-light border-0 small"
                        placeholder="Search for..."
                        aria-label="Search"
                        aria-describedby="basic-addon2"
                      />
                      <div class="input-group-append">
                        <button class="btn btn-primary" type="button">
                          <i class="fas fa-search fa-sm"></i>
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </li>

              <div class="topbar-divider d-none d-sm-block"></div>

              <!-- Nav Item - User Information -->
              <li class="nav-item dropdown no-arrow">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="userDropdown"
                  role="button"
                  data-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <span
                    class="mr-2 d-none d-lg-inline text-gray-600 small"
                    id="fullname"
                    style="text-transform: capitalize"
                    >Valerie Luna</span
                  >
                  <img
                    class="img-profile rounded-circle"
                    src="https://source.unsplash.com/QAB-WJcbgJk/60x60"
                  />
                </a>
                <!-- Dropdown - User Information -->
                <div
                  class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                  aria-labelledby="userDropdown"
                >
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                    Profile
                  </a>
                
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" onclick="logout()">
                    <i
                      class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"
                    ></i>
                    Logout
                  </a>
                </div>
              </li>
            </ul>
          </nav>
          <!-- End of Topbar -->

          <!-- Begin Page Content -->
          <div class="container-fluid">
            <!-- Page Heading -->
            <div
              class="d-sm-flex align-items-center justify-content-between mb-4"
            >
              <h1 class="h3 mb-0 text-gray-800">Payments</h1>
            </div>

            <div class="card">
              <div class="card-header">My Payments</div>
              <div class="card-body">
                <div class="table-responsive">
                  <table
                    class="table table-bordered"
                    id="dataTable"
                    width="100%"
                    cellspacing="0"
                  >
                    <thead class="">
                      <tr>
                        <th class="text-center">Username</th>
                        <th class="text-center">Plan</th>
                        <th class="text-center">Capital</th>
                        <th class="text-center">Earnings</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Proof </th>
                        <th class="text-center">Payment status</th>
                        <th class="text-center">Payment</th>
                        <th class="text-center">Verification</th>
                        <th class="text-center">Date</th>
                      </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- /.container-fluid -->
        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <footer class="sticky-footer bg-white">
          <div class="container my-auto">
            <div class="copyright text-center my-auto">
              &copy; Copyright 2020 <strong> Lfamarkets</strong>. All Rights
              Reserved
            </div>
          </div>
        </footer>
        <!-- End of Footer -->
      </div>
      <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
      var user = JSON.parse(localStorage.getItem("typeAdmin"));

      document.getElementById("username").innerHTML = `Hi ${user.username}`;
      document.getElementById("fullname").innerHTML = user.name;

      function logout() {
        localStorage.removeItem("typeAdmin");
        window.location.href = "/lfamarket/admin/login.html";
      }

      function verifyPayment(val, index) {
        axios
          .get(
            `https://lfamarket-api.herokuapp.com/api/verify-payment/${val.investment_id}/${val.plan}`
          )
          .then((res) => {
            if (res.status == 200) {
              if (res.data.verified) {
                document.getElementById(`stat${index}`).innerHTML = "Verified";
                document.getElementById(`earning${index}`).innerHTML = `R${number_format(res.data.earning)}`;
              }
              document.getElementById(`verify${index}`).firstChild.value = 'Unverify'
              document.getElementById(`verify${index}`).firstChild.onclick = function () {
               
               unverify(val, index);
             };
            }
             
          
          });
      }
      function unverify(val, index) {
        axios
          .get(
            `https://lfamarket-api.herokuapp.com/api/unverify-payment/${val.investment_id}/${val.plan}`
          )
          .then((res) => {
            if (res.status == 200) {
             
                document.getElementById(`stat${index}`).innerHTML = "Unverified";
                document.getElementById(`earning${index}`).innerHTML = `R0.00`;
                document.getElementById(`verify${index}`).firstChild.value = 'Verify'
                document.getElementById(`verify${index}`).firstChild.onclick = function () {
               
                  verifyPayment(val, index);
             };
             
            }
          });
      }

      function getData() {
        axios.get("https://lfamarket-api.herokuapp.com/api/all-payments").then((res) => {
          if (res.status == 200) {
            var table = document.getElementById("tbody");

            res.data.forEach((item, index) => {
              var button = document.createElement("input");
              button.type = "button";
              button.name = "Verify";
              button.value = "Verify";
              button.onclick = function () {
                // Note this is a function
                verifyPayment(item, index);
              };
              var link = document.createElement("a");
              link.href = item.url;
              link.title = "View proof";
              link.target = "_blank";
              var linkText = document.createTextNode("View payment");
              link.appendChild(linkText);

              var button1 = document.createElement("input");
              button1.type = "button";
              button1.name = "Verify";
              button1.value = "Click to Pay";

              var button2 = document.createElement("input");
              button2.type = "button";
              button2.name = "Unverify";
              button2.value = "Unverify";
             
              if (item.status =='active') {
                button1.classList.add('disabled')
              }else{
                button1.onclick = function () {
                // Note this is a function
                pay(item);
              };
              }

              button2.onclick = function () {
               
                unverify(item, index);
              };
            

              button.classList.add("btn", "btn-primary", "btn-sm");
              button1.classList.add("btn", "btn-primary", "btn-sm");
              button2.classList.add("btn", "btn-primary", "btn-sm");
              var row = table.insertRow(0);
              var cell1 = row.insertCell(0);
              var cell2 = row.insertCell(1);
              var cell3 = row.insertCell(2);
              var cell4 = row.insertCell(3);
              var cell5 = row.insertCell(4);
              var cell6 = row.insertCell(5);
              var cell7 = row.insertCell(6);
              var cell8 = row.insertCell(7);
              var cell9 = row.insertCell(8);
              var cell10 = row.insertCell(9);

              cell4.setAttribute("id", `earning${index}`);
              cell5.setAttribute("id", `stat${index}`);
              cell9.setAttribute("id", `verify${index}`);
              cell1.innerHTML = `${item.username} `;
              cell2.innerHTML = `${item.plan} months`;
              cell3.innerHTML = `R${number_format(item.amount_paid)}`;
              cell4.innerHTML = `R${number_format(item.earning)}`;
              cell5.innerHTML = `${item.verified ? "Verified" : "Unverified"}`;
              cell6.appendChild(link);
              cell7.innerHTML = `${item.status=='due' ? "Payment due" : "Ongoing"}`;
              cell8.appendChild(button1);
              item.verified?cell9.appendChild(button2):cell9.appendChild(button)
              
              cell1.classList.add("toCaps");
              cell2.classList.add("toCaps");
              cell10.innerHTML = new Date(item.createdAt).toLocaleDateString()
            });
          }
        });
      }

      

      function number_format(number, decimals, dec_point, thousands_sep) {
        // *     example: number_format(1234.56, 2, ',', ' ');
        // *     return: '1 234,56'
        number = (number + "").replace(",", "").replace(" ", "");
        var n = !isFinite(+number) ? 0 : +number,
          prec = !isFinite(+decimals) ? 0 : Math.abs(decimals),
          sep = typeof thousands_sep === "undefined" ? "," : thousands_sep,
          dec = typeof dec_point === "undefined" ? "." : dec_point,
          s = "",
          toFixedFix = function (n, prec) {
            var k = Math.pow(10, prec);
            return "" + Math.round(n * k) / k;
          };
        // Fix for IE parseFloat(0.55).toFixed(0) = 0;
        s = (prec ? toFixedFix(n, prec) : "" + Math.round(n)).split(".");
        if (s[0].length > 3) {
          s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep);
        }
        if ((s[1] || "").length < prec) {
          s[1] = s[1] || "";
          s[1] += new Array(prec - s[1].length + 1).join("0");
        }
        return s.join(dec);
      }
      function pay(val) {
        axios
        .get(`https://lfamarket-api.herokuapp.com/api/get-referrals/${val.username}`)
        .then((res) => {
          if (res.status == 200) {
             var amount = res.data.map(item=>item.amount).reduce((a,b)=>{
               return Number(a)+Number(b)
             })
        var total =   Number(val.earning) + Number(amount)
      
          }
        });
        alert("pay now");
      }
      getData();
    </script>

    <!-- Bootstrap core JavaScript-->
    <script src="../assets/vendor/jquery/jquery.min.js"></script>
    <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="../assets/vendor/jquery.easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="../assets/js/sb-admin-2.min.js"></script>
    <!-- Page level plugins -->
    <script src="../assets/vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="../assets/vendor/datatables/dataTables.bootstrap4.min.js"></script>
  </body>
</html>
